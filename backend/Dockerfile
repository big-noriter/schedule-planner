# ==========================================
# ðŸ—ï¸ ë¹Œë“œ ìŠ¤í…Œì´ì§€
# ==========================================
FROM node:18-alpine AS builder

# ìž‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# package.json ë³µì‚¬ ë° ì˜ì¡´ì„± ì„¤ì¹˜
COPY package*.json ./
RUN npm ci

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# TypeScript ë¹Œë“œ
RUN npm run build

# ==========================================
# ðŸš€ í”„ë¡œë•ì…˜ ìŠ¤í…Œì´ì§€
# ==========================================
FROM node:18-alpine AS production

# ìž‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# package.json ë³µì‚¬ ë° í”„ë¡œë•ì…˜ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force

# ë¹Œë“œëœ ê²°ê³¼ë¬¼ ë³µì‚¬
COPY --from=builder /app/dist ./dist

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE $PORT

# í—¬ìŠ¤ì²´í¬ ì¶”ê°€
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:${PORT:-3000}/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })"

# ì„œë²„ ì‹œìž‘
CMD ["npm", "start"] 